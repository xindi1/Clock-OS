<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clock OS 1.0 – Five Clock MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f4f7ff;
      --card-bg: #ffffff;
      --primary: #1e88e5;
      --primary-soft: #e3f2fd;
      --accent: #42a5f5;
      --text-main: #1f2933;
      --text-soft: #6b778c;
      --border-soft: #d0d7e2;
      --shadow-soft: 0 10px 20px rgba(15, 35, 95, 0.08);
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #e3f2fd, #f4f7ff 45%, #ffffff);
      min-height: 100vh;
      color: var(--text-main);
      padding: 24px 16px 32px;
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 1120px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: var(--primary);
    }

    .brand-subtitle {
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: var(--radius-pill);
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.85rem;
      font-weight: 500;
    }

    .pill-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .time-display {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }

    .readiness-score {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
    }

    .readiness-score span.value {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .readiness-score span.label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .readiness-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 18px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title span.badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: #f0f4ff;
      color: var(--text-soft);
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .tile-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 650px) {
      .tile-grid {
        grid-template-columns: 1fr;
      }
    }

    .clock-tile {
      border-radius: var(--radius-md);
      padding: 10px 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, #ffffff, #f7f9ff);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .clock-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .clock-name {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .clock-score {
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .score-pill {
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      background: var(--primary-soft);
      font-variant-numeric: tabular-nums;
    }

    .clock-phase {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .clock-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .clock-meta span.key {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
    }

    .clock-meta span.value {
      font-variant-numeric: tabular-nums;
    }

    .btn {
      border: none;
      outline: none;
      cursor: pointer;
      border-radius: var(--radius-pill);
      padding: 6px 12px;
      font-size: 0.78rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--primary);
      color: #ffffff;
      transition: transform 0.05s ease, box-shadow 0.05s ease,
        background 0.1s ease;
      box-shadow: 0 4px 10px rgba(25, 118, 210, 0.25);
    }

    .btn-ghost {
      background: #f5f7ff;
      color: var(--text-soft);
      box-shadow: none;
      border-radius: var(--radius-pill);
      padding: 4px 10px;
      border: none;
      cursor: pointer;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-ghost:hover {
      background: #e4ebff;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(25, 118, 210, 0.3);
      background: var(--accent);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 3px 8px rgba(25, 118, 210, 0.2);
    }

    .priority-highlight {
      background: linear-gradient(135deg, #e3f2fd, #ffffff);
      border-radius: var(--radius-lg);
      padding: 10px 12px;
      border: 1px dashed rgba(66, 165, 245, 0.6);
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 8px;
    }

    .priority-main {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .priority-meta {
      font-size: 0.78rem;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 6px;
    }

    .quick-log-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .quick-log-row .btn-ghost {
      font-size: 0.75rem;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px 14px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .field input,
    .field select,
    .field textarea {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 7px 9px;
      font-size: 0.85rem;
      outline: none;
      background: #f9fbff;
    }

    .field textarea {
      resize: vertical;
      min-height: 48px;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: var(--primary);
      background: #ffffff;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .link {
      font-size: 0.8rem;
      color: var(--primary);
      text-decoration: none;
    }

    .link:hover {
      text-decoration: underline;
    }

    .small {
      font-size: 0.75rem;
      color: var(--text-soft);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand-block">
        <div class="brand-title">Clock OS 1.0</div>
        <div class="brand-subtitle">
          Five-clock temporal engine – Sun • Focus • Sleep • Energy • Priority
        </div>
      </div>
      <div class="status-bar">
        <div class="pill">
          <span class="pill-label">Local Time</span>
          <span id="timeDisplay" class="time-display">--:--</span>
        </div>
        <div class="pill">
          <div class="readiness-score">
            <span class="label">Readiness</span>
            <span class="value" id="readinessValue">--</span>
            <span>/ 100</span>
          </div>
          <span
            id="readinessDot"
            class="readiness-dot"
            style="background:#cbd2e1;"
          ></span>
        </div>
      </div>
    </header>

    <!-- Today Summary Bar -->
    <div id="todaySummaryBar"
         style="margin-bottom:18px; padding:10px 14px;
                background:linear-gradient(135deg,#eef5ff,#ffffff);
                border-radius:14px;border:1px solid #dce6f7;
                font-size:0.8rem;color:#4a5668;
                display:flex;gap:14px;flex-wrap:wrap;">
      Today Summary: loading…
    </div>

    <main class="grid">
      <!-- LEFT: Priority + quick controls -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            Priority Clock
            <span class="badge">OS MIND</span>
          </div>
          <button class="btn-ghost" id="recomputeBtn">Recompute</button>
        </div>
        <div class="card-subtitle">
          Converts your circadian, cognitive, sleep, and energy states into a single readiness score that recommends your best next action.
        </div>

        <div class="priority-highlight">
          <div class="priority-main" id="prioritySuggestion">
            Best Next Action will appear here based on your clock scores.
          </div>
          <div class="priority-meta">
            <span><strong>Window:</strong> <span id="priorityWindow">--</span></span>
            <span><strong>Mode:</strong> <span id="priorityMode">--</span></span>
          </div>
        </div>

        <div class="quick-log-row">
          <button class="btn-ghost" data-open-modal="sun">Log sun exposure</button>
          <button class="btn-ghost" data-open-modal="focus">Log focus</button>
          <button class="btn-ghost" data-open-modal="sleep">Log sleep</button>
          <button class="btn-ghost" data-open-modal="energy">Log energy</button>
        </div>

        <div style="margin-top:14px;">
          <div class="small">
            Tip: think of this dashboard as your temporal compass. The more you log, the smarter the clocks get.
          </div>
        </div>
      </section>

      <!-- RIGHT: the four input clocks -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            Clocks
            <span class="badge">SUN • FOCUS • SLEEP • ENERGY</span>
          </div>
          <a href="#" class="link" id="resetDataLink">Reset data</a>
        </div>
        <div class="card-subtitle">
          Each clock reflects a different internal rhythm: circadian alignment, cognitive clarity, sleep recovery, and energy patterns.
        </div>

        <div class="tile-grid">
          <!-- Sun Clock -->
          <div class="clock-tile" id="sunTile">
            <div class="clock-header-row">
              <div class="clock-name">Sun Clock</div>
              <div class="clock-score">
                <span>Align</span>
                <span class="score-pill" id="sunScore">--</span>
              </div>
            </div>
            <div class="clock-phase" id="sunPhase">Tracks your current circadian phase.</div>
            <div class="clock-meta">
              <span class="key">Next event</span>
              <span class="value" id="sunNextEvent">--</span>
            </div>
            <div class="clock-meta">
              <span class="key">Logs</span>
              <span class="value" id="sunLogCount">0 entries</span>
            </div>
            <div style="margin-top:6px;">
              <button class="btn-ghost" data-open-modal="sun">Log exposure</button>
            </div>
          </div>

          <!-- Focus Clock -->
          <div class="clock-tile" id="focusTile">
            <div class="clock-header-row">
              <div class="clock-name">Focus Clock</div>
              <div class="clock-score">
                <span>Focus</span>
                <span class="score-pill" id="focusScore">--</span>
              </div>
            </div>
            <div class="clock-phase" id="focusPhase">Shows your mental sharpness window.</div>
            <div class="clock-meta">
              <span class="key">Sessions</span>
              <span class="value" id="focusSessionCount">0</span>
            </div>
            <div class="clock-meta">
              <span class="key">Last rating</span>
              <span class="value" id="focusLastRating">--</span>
            </div>
            <div style="margin-top:6px;">
              <button class="btn-ghost" data-open-modal="focus">Log focus session</button>
            </div>
          </div>

          <!-- Sleep Clock -->
          <div class="clock-tile" id="sleepTile">
            <div class="clock-header-row">
              <div class="clock-name">Sleep Clock</div>
              <div class="clock-score">
                <span>Recovery</span>
                <span class="score-pill" id="sleepScore">--</span>
              </div>
            </div>
            <div class="clock-phase" id="sleepPhase">Reflects your recovery state today.</div>
            <div class="clock-meta">
              <span class="key">Last night</span>
              <span class="value" id="sleepLastNight">--</span>
            </div>
            <div class="clock-meta">
              <span class="key">Consistency</span>
              <span class="value" id="sleepConsistency">--</span>
            </div>
            <div style="margin-top:6px;">
              <button class="btn-ghost" data-open-modal="sleep">Log last night</button>
            </div>
          </div>

          <!-- Energy Clock -->
          <div class="clock-tile" id="energyTile">
            <div class="clock-header-row">
              <div class="clock-name">Energy Clock</div>
              <div class="clock-score">
                <span>Energy</span>
                <span class="score-pill" id="energyScore">--</span>
              </div>
            </div>
            <div class="clock-phase" id="energyPhase">Current physical & mental energy phase.</div>
            <div class="clock-meta">
              <span class="key">Last log</span>
              <span class="value" id="energyLastRating">--</span>
            </div>
            <div class="clock-meta">
              <span class="key">Trend</span>
              <span class="value" id="energyTrend">--</span>
            </div>
            <div style="margin-top:6px;">
              <button class="btn-ghost" data-open-modal="energy">Log energy</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Log</div>
        <button class="btn-ghost" id="modalCloseBtn">Close</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Dynamic fields injected by JS -->
      </div>
      <div class="modal-footer">
        <button class="btn-ghost" id="modalCancelBtn">Cancel</button>
        <button class="btn" id="modalSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "clockOS_v1_state";

    const defaultState = {
      sunLogs: [],
      focusLogs: [],
      sleepLogs: [],
      energyLogs: [],
      meta: { createdAt: new Date().toISOString() }
    };

    let state = loadState();
    let currentModalClock = null;

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return { ...structuredClone(defaultState), ...parsed };
      } catch (e) {
        console.warn("Failed to load state, using default.", e);
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function pad(n) {
      return n.toString().padStart(2, "0");
    }

    function getLocalTimeString() {
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function getHour() {
      return new Date().getHours();
    }

    function computeSunPhase(hour) {
      if (hour < 5) return "Night";
      if (hour < 7) return "Pre-dawn";
      if (hour < 11) return "Morning Ascent";
      if (hour < 14) return "Midday Peak";
      if (hour < 18) return "Afternoon Descent";
      if (hour < 20) return "Golden Hour";
      if (hour < 22) return "Wind-down Window";
      return "Melatonin Rise";
    }

    function getSunAlignmentScore() {
      if (!state.sunLogs.length) return 50;
      const daylightLogs = state.sunLogs.filter((log) => {
        const h = new Date(log.timestamp).getHours();
        return h >= 8 && h <= 18;
      });
      let score = 50 + Math.min(daylightLogs.length * 5, 40);
      return Math.round(score);
    }

    function getNextSunEvent(hour) {
      if (hour < 7) return "Sunrise ~07:00";
      if (hour < 12) return "Solar peak ~12:00";
      if (hour < 18) return "Sunset ~18:00";
      if (hour < 22) return "Biological night deepens";
      return "Pre-dawn in a few hours";
    }

    function getFocusScore() {
      if (!state.focusLogs.length) return 60;
      const recent = state.focusLogs.slice(-5);
      const avgRating =
        recent.reduce((sum, l) => sum + (l.rating || 0), 0) / recent.length;
      const avgDuration =
        recent.reduce((sum, l) => sum + (l.durationMin || 0), 0) /
        Math.max(recent.length, 1);
      let score = 40 + avgRating * 8 + Math.min(avgDuration, 60) * 0.2;
      return Math.max(0, Math.min(100, Math.round(score)));
    }

    function getFocusPhase(hour) {
      if (hour < 8) return "Warm-up";
      if (hour < 11) return "Peak Focus Window";
      if (hour < 15) return "Sustained Flow";
      if (hour < 18) return "Degradation Window";
      return "Recovery / Low Focus";
    }

    function getSleepScore() {
      if (!state.sleepLogs.length) return 65;
      const last = state.sleepLogs[state.sleepLogs.length - 1];
      const hours = last.hours || 0;
      const quality = last.quality || 3;
      let score = 20 + hours * 8 + quality * 6;
      return Math.max(0, Math.min(100, Math.round(score)));
    }

    function getSleepPhase(hour) {
      if (hour >= 23 || hour < 2) return "Deep biological night";
      if (hour < 6) return "Late night / sleep";
      if (hour < 9) return "Morning wake window";
      if (hour < 21) return "Daytime / active";
      return "Wind-down window";
    }

    function getSleepConsistency() {
      if (state.sleepLogs.length < 3) return "Insufficient data";
      const last3 = state.sleepLogs.slice(-5);
      const bedtimes = last3.map((l) => l.bedtimeHour ?? 23);
      const avg =
        bedtimes.reduce((s, h) => s + h, 0) / Math.max(bedtimes.length, 1);
      const variance =
        bedtimes.reduce((s, h) => s + Math.pow(h - avg, 2), 0) /
        Math.max(bedtimes.length, 1);
      const std = Math.sqrt(variance);
      if (std <= 0.7) return "Very consistent";
      if (std <= 1.5) return "Fairly consistent";
      return "Irregular";
    }

    function getEnergyScore() {
      if (!state.energyLogs.length) return 65;
      const recent = state.energyLogs.slice(-6);
      const avgRating =
        recent.reduce((s, l) => s + (l.rating || 0), 0) / recent.length;
      const latest = recent[recent.length - 1].rating || avgRating;
      let score = 40 + avgRating * 6 + latest * 4;
      return Math.max(0, Math.min(100, Math.round(score)));
    }

    function getEnergyPhase(hour, score) {
      if (score >= 80) return "Peak / High output";
      if (score >= 60) return "Charged / Stable";
      if (score >= 40) return "Drift / Mild fatigue";
      return "Depleted / Low reserve";
    }

    function getEnergyTrend() {
      const logs = state.energyLogs;
      if (logs.length < 2) return "Stable";
      const last3 = logs.slice(-3);
      const start = last3[0].rating;
      const end = last3[last3.length - 1].rating;
      if (end > start + 0.5) return "Improving";
      if (end < start - 0.5) return "Declining";
      return "Stable";
    }

    function computeReadiness() {
      const sunScore = getSunAlignmentScore();
      const focusScore = getFocusScore();
      const sleepScore = getSleepScore();
      const energyScore = getEnergyScore();

      const readiness =
        0.2 * sunScore +
        0.3 * focusScore +
        0.25 * sleepScore +
        0.25 * energyScore;

      return Math.round(readiness);
    }

    function classifyReadinessColor(score) {
      if (score >= 80) return "#34c759";
      if (score >= 60) return "#ffcc00";
      if (score >= 40) return "#ff9500";
      return "#ff3b30";
    }

    function computePrioritySuggestion(score) {
      const hour = getHour();
      const focusPhase = getFocusPhase(hour);
      const energyScore = getEnergyScore();
      const sleepScore = getSleepScore();

      let mode = "Balance";
      let suggestion = "Hold neutral—capture light logs, minor chores, admin.";
      let window = "30–45 minutes";

      if (score >= 80 && focusPhase.includes("Peak")) {
        mode = "Deep work";
        suggestion =
          "High-readiness deep work window. Prioritize cognitively demanding tasks (writing, strategy, analysis).";
        window = "45–90 minutes";
      } else if (score >= 70 && energyScore >= 70) {
        mode = "Focused execution";
        suggestion =
          "Good window for execution: knock out structured tasks, trading prep, or coding.";
        window = "30–60 minutes";
      } else if (score <= 45 || sleepScore <= 50) {
        mode = "Recovery";
        suggestion =
          "Low readiness. Reduce new commitments. Optimize for rest, sunlight, light movement, and low-stakes tasks.";
        window = "20–40 minutes recovery";
      } else if (energyScore <= 55) {
        mode = "Maintenance";
        suggestion =
          "Energy is middling. Favor maintenance tasks, journaling, and light planning over heavy lifting.";
        window = "25–40 minutes";
      }

      return { mode, suggestion, window };
    }

    function updateTime() {
      document.getElementById("timeDisplay").textContent = getLocalTimeString();
      const h = getHour();
      document.getElementById("sunPhase").textContent = computeSunPhase(h);
      document.getElementById("sunNextEvent").textContent = getNextSunEvent(h);
    }

    function updateClocks() {
      const hour = getHour();

      const sunScore = getSunAlignmentScore();
      document.getElementById("sunScore").textContent = sunScore;
      document.getElementById("sunLogCount").textContent =
        state.sunLogs.length + " entries";

      const focusScore = getFocusScore();
      document.getElementById("focusScore").textContent = focusScore;
      document.getElementById("focusPhase").textContent = getFocusPhase(hour);
      document.getElementById("focusSessionCount").textContent =
        state.focusLogs.length;
      const lastFocus =
        state.focusLogs[state.focusLogs.length - 1]?.rating ?? null;
      document.getElementById("focusLastRating").textContent =
        lastFocus != null ? lastFocus + "/5" : "--";

      const sleepScore = getSleepScore();
      document.getElementById("sleepScore").textContent = sleepScore;
      document.getElementById("sleepPhase").textContent = getSleepPhase(hour);
      const lastSleep = state.sleepLogs[state.sleepLogs.length - 1] || null;
      document.getElementById("sleepLastNight").textContent = lastSleep
        ? `${lastSleep.hours}h, quality ${lastSleep.quality}/5`
        : "--";
      document.getElementById("sleepConsistency").textContent =
        getSleepConsistency();

      const energyScore = getEnergyScore();
      document.getElementById("energyScore").textContent = energyScore;
      const lastEnergy =
        state.energyLogs[state.energyLogs.length - 1]?.rating ?? null;
      document.getElementById("energyLastRating").textContent =
        lastEnergy != null ? lastEnergy + "/5" : "--";
      document.getElementById("energyPhase").textContent = getEnergyPhase(
        hour,
        energyScore
      );
      document.getElementById("energyTrend").textContent = getEnergyTrend();

      const readiness = computeReadiness();
      document.getElementById("readinessValue").textContent = readiness;
      document.getElementById("readinessDot").style.background =
        classifyReadinessColor(readiness);

      const { mode, suggestion, window } =
        computePrioritySuggestion(readiness);
      document.getElementById("prioritySuggestion").textContent = suggestion;
      document.getElementById("priorityWindow").textContent = window;
      document.getElementById("priorityMode").textContent = mode;
    }

    function updateTodaySummary() {
      const sun = getSunAlignmentScore();
      const focus = getFocusScore();
      const sleep = getSleepScore();
      const energy = getEnergyScore();
      const readiness = computeReadiness();

      const text = `Today Summary: Readiness ${readiness} • Focus ${focus} • Energy ${energy} • Sleep ${sleep} • Sun ${sun}`;
      document.getElementById("todaySummaryBar").textContent = text;
    }

    function fullRefresh() {
      updateTime();
      updateClocks();
      updateTodaySummary();
    }

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");

    function openModal(clockId) {
      currentModalClock = clockId;
      modalBody.innerHTML = "";

      if (clockId === "sun") {
        modalTitle.textContent = "Log sun exposure";
        modalBody.innerHTML = `
          <div class="field">
            <label>Minutes outdoors</label>
            <input type="number" id="sunMinutes" min="1" max="240" placeholder="e.g., 10" />
          </div>
          <div class="field">
            <label>Note (optional)</label>
            <textarea id="sunNote" placeholder="Morning walk, commute, etc."></textarea>
          </div>
        `;
      } else if (clockId === "focus") {
        modalTitle.textContent = "Log focus session";
        modalBody.innerHTML = `
          <div class="field">
            <label>Duration (minutes)</label>
            <input type="number" id="focusDuration" min="5" max="240" placeholder="e.g., 25" />
          </div>
          <div class="field">
            <label>Focus quality (1–5)</label>
            <select id="focusRating">
              <option value="5">5 – Laser focused</option>
              <option value="4">4 – Strong</option>
              <option value="3">3 – Mixed</option>
              <option value="2">2 – Scattered</option>
              <option value="1">1 – Very unfocused</option>
            </select>
          </div>
          <div class="field">
            <label>Note (optional)</label>
            <textarea id="focusNote" placeholder="What were you working on?"></textarea>
          </div>
        `;
      } else if (clockId === "sleep") {
        modalTitle.textContent = "Log last night's sleep";
        modalBody.innerHTML = `
          <div class="field">
            <label>Hours slept (approx.)</label>
            <input type="number" id="sleepHours" min="2" max="12" step="0.25" placeholder="e.g., 7.5" />
          </div>
          <div class="field">
            <label>Sleep quality (1–5)</label>
            <select id="sleepQuality">
              <option value="5">5 – Excellent</option>
              <option value="4">4 – Good</option>
              <option value="3">3 – Okay</option>
              <option value="2">2 – Poor</option>
              <option value="1">1 – Very poor</option>
            </select>
          </div>
          <div class="field">
            <label>Approximate bedtime (24h)</label>
            <input type="number" id="sleepBedtime" min="18" max="30" placeholder="e.g., 23 means 23:00; 26 means 02:00" />
          </div>
          <div class="field">
            <label>Note (optional)</label>
            <textarea id="sleepNote" placeholder="Woke up at night, late screen time, etc."></textarea>
          </div>
        `;
      } else if (clockId === "energy") {
        modalTitle.textContent = "Log energy check-in";
        modalBody.innerHTML = `
          <div class="field">
            <label>Energy level (1–5)</label>
            <select id="energyRating">
              <option value="5">5 – High / charged</option>
              <option value="4">4 – Good</option>
              <option value="3">3 – Neutral</option>
              <option value="2">2 – Low</option>
              <option value="1">1 – Very low</option>
            </select>
          </div>
          <div class="field">
            <label>Note (optional)</label>
            <textarea id="energyNote" placeholder="Meals, stress, movement, etc."></textarea>
          </div>
        `;
      }

      modalBackdrop.style.display = "flex";
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
      currentModalClock = null;
    }

    function saveModal() {
      if (!currentModalClock) return;

      const now = new Date().toISOString();

      if (currentModalClock === "sun") {
        const minutes = parseInt(
          document.getElementById("sunMinutes").value || "0",
          10
        );
        const note = document.getElementById("sunNote").value.trim();
        if (minutes > 0) {
          state.sunLogs.push({ timestamp: now, minutes, note });
        }
      } else if (currentModalClock === "focus") {
        const duration = parseInt(
          document.getElementById("focusDuration").value || "0",
          10
        );
        const rating = parseInt(
          document.getElementById("focusRating").value || "3",
          10
        );
        const note = document.getElementById("focusNote").value.trim();
        if (duration > 0) {
          state.focusLogs.push({
            timestamp: now,
            rating,
            durationMin: duration,
            note
          });
        }
      } else if (currentModalClock === "sleep") {
        const hours = parseFloat(
          document.getElementById("sleepHours").value || "0"
        );
        const quality = parseInt(
          document.getElementById("sleepQuality").value || "3",
          10
        );
        const bedtimeHourRaw = parseFloat(
          document.getElementById("sleepBedtime").value || "23"
        );
        const note = document.getElementById("sleepNote").value.trim();
        if (hours > 0) {
          const dateStr = new Date().toISOString().slice(0, 10);
          state.sleepLogs.push({
            dateStr,
            hours,
            quality,
            bedtimeHour: bedtimeHourRaw,
            note
          });
        }
      } else if (currentModalClock === "energy") {
        const rating = parseInt(
          document.getElementById("energyRating").value || "3",
          10
        );
        const note = document.getElementById("energyNote").value.trim();
        state.energyLogs.push({ timestamp: now, rating, note });
      }

      saveState();
      fullRefresh();
      closeModal();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("[data-open-modal]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const clockId = btn.getAttribute("data-open-modal");
          openModal(clockId);
        });
      });

      document.getElementById("modalCloseBtn").addEventListener("click", closeModal);
      document.getElementById("modalCancelBtn").addEventListener("click", closeModal);
      document.getElementById("modalSaveBtn").addEventListener("click", saveModal);

      document.getElementById("recomputeBtn").addEventListener("click", fullRefresh);

      document.getElementById("resetDataLink").addEventListener("click", (e) => {
        e.preventDefault();
        if (confirm("Reset all Clock OS data on this device? This cannot be undone.")) {
          state = structuredClone(defaultState);
          saveState();
          fullRefresh();
        }
      });

      fullRefresh();
      setInterval(updateTime, 1000);
    });
  </script>
</body>
</html>
